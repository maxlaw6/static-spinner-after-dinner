<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>Spinner after Dinner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
    <style>
        /* General Body and Layout Styles */
        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            user-select: none;
            -webkit-user-select: none; /* Safari */
            background-color: #1f2937; /* bg-gray-800 */
        }

        /* Game World and Board Styles */
        #world {
            position: relative;
            overflow: hidden;
            cursor: grab;
            width: 100%;
            height: 100%;
            background-color: #00693E; /* Felt Green */
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 10%, transparent 0);
            background-size: 5px 5px;
            border-radius: 20px; /* Rounded corners for the table */
            touch-action: none; /* Critical for smooth touch controls on iPad */
        }
        #world.panning {
            cursor: grabbing;
        }
        #game-board {
            position: absolute;
            width: 2500px;
            height: 2500px;
            transform-origin: top left;
            will-change: transform; /* Performance hint for the browser */
        }
        #starting-area {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 84px;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 8px;
        }

        /* Domino Styles */
        .domino {
            width: 80px;
            height: 40px;
            border: 1px solid #1a1a1a;
            background-color: #f7f7f7;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-radius: 6px;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2), inset 0 0 2px rgba(0,0,0,0.2);
            transform-origin: center center;
            color: #1a1a1a;
            transition: box-shadow 0.2s ease, transform 0.25s ease, top 0.3s ease, left 0.3s ease;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on iOS */
        }
        .domino.domino-back {
            background-color: #f7f7f7;
            border: 1px solid #a0aec0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }
        .domino.domino-back::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 10%;
            height: 80%;
            width: 2px;
            background-color: rgba(0,0,0,0.1);
            transform: translateX(-50%);
        }
        .domino.dragging {
            cursor: grabbing;
            transition: none !important;
            z-index: 3000 !important;
            position: fixed !important;
            top: 0;
            left: 0;
            opacity: 0.95;
            pointer-events: none;
            transform-origin: center center; 
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* Mini Domino Styles for Opponent Hands */
        .mini-domino {
            width: 40px;
            height: 20px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            cursor: default !important;
        }
        .mini-domino.domino-back::after {
            width: 1px;
        }

        /* Pip and Spinner Styles */
        .pip-container {
            width: 50%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            align-items: center;
            justify-items: center;
            padding: 4px;
            pointer-events: none;
        }
        .divider {
            width: 2px;
            height: 80%;
            background-color: #1a1a1a;
            pointer-events: none;
        }
        .pip {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
            backface-visibility: hidden;
            transform: translateZ(0);
        }
        .pip-color-0 { background-color: #cbd5e0; }
        .pip-color-1 { background-color: #EADCA6; }
        .pip-color-2 { background-color: #8B0000; }
        .pip-color-3 { background-color: #800000; }
        .pip-color-4 { background-color: #00BFFF; }
        .pip-color-5 { background-color: #006400; }
        .pip-color-6 { background-color: #000000; }
        .pip-color-7 { background-color: #A0522D; }
        .pip-color-8 { background-color: #9370DB; }
        .pip-color-9 { background-color: #808080; }
        
        .spinner-icon {
            width: 24px;
            height: 24px;
            grid-column: 1 / -1;
            grid-row: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            line-height: 1.1;
        }
        .spinner-icon svg {
            width: 100%;
            height: 100%;
        }


        /* UI Components */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #boneyard-pile {
            border: 2px dashed #a0aec0;
            height: 60px;
            width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            position: relative;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.2);
        }
        #boneyard-pile:hover {
            background-color: rgba(255,255,255,0.1);
        }
        #boneyard-stack {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .boneyard-domino-display {
            width: 80px;
            height: 40px;
            border: 1px solid #a0aec0;
            background-color: #f7f7f7;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #boneyard-count {
            position: absolute;
            z-index: 10;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            background-color: rgba(0,0,0,0.6);
            padding: 2px 10px;
            border-radius: 12px;
            text-shadow: 0 0 5px #000;
        }
        #boneyard-message {
            position: absolute;
            z-index: 11;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px #000;
            pointer-events: none;
        }
        @keyframes flash-border {
            0%, 100% { border-color: #a0aec0; box-shadow: none; }
            50% { border-color: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        }
        .flashing-border {
            animation: flash-border 1.5s infinite;
        }
        #boneyard-pile.can-draw {
            animation: flash-border 1.5s infinite;
        }
        #minimap-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            z-index: 2000;
            cursor: pointer;
        }
        #minimap-viewport {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }
        .minimap-dot {
            position: absolute;
            width: 8px;
            height: 4px;
            background-color: white;
            border-radius: 1px;
            pointer-events: auto;
            cursor: pointer;
            border: 1px solid white;
            box-shadow: 0 0 5px rgba(255,255,255,0.6);
            transform-origin: center;
        }
        .player-hand-section {
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            transition: all 0.3s ease;
            background-color: rgba(0,0,0,0.3);
        }
        .player-hand-content {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
        }
        #setup-screen, #round-end-screen, #loading-screen, #game-over-screen, #message-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        #setup-screen > div {
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .hidden {
            display: none !important;
        }
        #final-score-display, #round-end-content, #message-modal-content {
            background-color: rgba(31, 41, 55, 0.9);
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .winner {
            color: #FFD700;
            font-weight: bold;
        }

        /* --- LAYOUT STYLES --- */
        #game-container {
            height: 100%;
            width: 100%;
        }
        #game-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            height: 100%;
            width: 100%;
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + env(safe-area-inset-right));
            padding-top: calc(1rem + env(safe-area-inset-top));
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            gap: 1rem;
            box-sizing: border-box;
        }
        #game-info { 
            grid-column: 1 / -1;
            grid-row: 1 / 2; 
        }
        #left-panel {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }
        #player-hands-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #boneyard-container {
            flex-shrink: 0;
        }
        #main-game-area {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            position: relative;
            display: grid;
            place-items: center;
            min-height: 0;
        }
        #main-game-area > * {
            grid-column: 1 / -1;
            grid-row: 1 / -1;
        }
        #world-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #boneyard-buttons {
            flex-direction: row;
        }
        
        #game-log {
            background-color: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 8px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 0.8rem;
            color: #d1d5db;
            min-width: 150px;
        }

        /* NEW: Styles for Validation */
        @keyframes pending-glow {
            0%, 100% { box-shadow: 0 0 10px 2px rgba(74, 222, 128, 0.7); } /* green-400 */
            50% { box-shadow: 0 0 20px 5px rgba(74, 222, 128, 1); }
        }
        .pending-validation-glow {
            animation: pending-glow 1.5s infinite;
        }

        /* NEW: Styles for Detailed Scoreboard */
        #detailed-scoreboard-container {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            flex-shrink: 1;
            min-height: 100px;
            overflow-y: auto;
        }
        #detailed-scoreboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        #detailed-scoreboard-table th, #detailed-scoreboard-table td {
            padding: 4px 6px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #detailed-scoreboard-table th {
            background-color: rgba(0,0,0,0.4);
            font-weight: bold;
        }
        #detailed-scoreboard-table .total-row td {
            font-weight: bold;
            background-color: rgba(31, 41, 55, 0.5); /* bg-gray-800 */
        }
        
        /* NEW: Styles for Local Player List */
        #local-player-list-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             background-color: #374151; /* bg-gray-700 */
             padding: 4px 8px;
             border-radius: 4px;
        }
         #local-player-list-item button {
             background-color: #ef4444; /* bg-red-500 */
             color: white;
             border: none;
             border-radius: 50%;
             width: 20px;
             height: 20px;
             font-weight: bold;
             line-height: 1;
             cursor: pointer;
         }


        @media (max-width: 1024px) {
            #game-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            #game-info { grid-row: 1 / 2; }
            #left-panel {
                grid-column: 1 / -1;
                grid-row: 2 / 3;
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 1rem;
            }
            #player-hands-container {
                flex-direction: row;
                flex-grow: 0;
            }
            .player-hand-section {
                flex-shrink: 0;
                width: 180px;
            }
            #boneyard-container {
                flex-shrink: 0;
            }
            #main-game-area {
                grid-column: 1 / -1;
                grid-row: 3 / 4;
            }
            #detailed-scoreboard-container {
                display: none; /* Hide detailed scoreboard on small screens for now */
            }
        }
    </style>
</head>
<body class="text-white">

<!-- Message Modal -->
<div id="message-modal" class="hidden">
    <div id="message-modal-content" class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm">
        <p id="message-text" class="text-lg mb-4"></p>
        <button id="message-ok-button" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-3 rounded transition-colors">OK</button>
    </div>
</div>

<!-- Loading Screen -->
<div id="loading-screen" class="flex items-center justify-center">
    <div class="text-center">
        <h1 class="text-3xl font-bold">Connecting to Game Service...</h1>
        <p id="auth-status">Initializing...</p>
    </div>
</div>

<!-- NEW: Pass Device Screen -->
<div id="pass-device-screen" class="hidden fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-90 z-[10000] flex items-center justify-center backdrop-filter backdrop-blur-md">
    <div id="pass-device-content" class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
        <h2 class="text-3xl font-bold mb-4">Pass the Device to...</h2>
        <p id="next-player-name-pass" class="text-5xl font-bold text-yellow-300 mb-8"></p>
        <button id="confirm-turn-button" class="w-full bg-green-600 hover:bg-green-700 font-bold py-4 px-6 rounded transition-colors text-xl">Show My Hand & Start Turn</button>
    </div>
</div>

<!-- Setup / Lobby Screen -->
<div class="hidden" id="setup-screen">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl text-white w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-6">Spinner after Dinner</h1>
        
        <div id="lobby-view">
            <div class="mb-4">
                <label class="block mb-2" for="player-name">Your Name:</label>
                <input class="w-full p-2 rounded bg-gray-700 text-white" id="player-name" placeholder="Enter your name" type="text"/>
            </div>
            
            <!-- Create Game Flow -->
            <div id="create-game-flow">
                <label class="block mb-2">Game Mode:</label>
                <div class="flex gap-4 mb-6">
                    <button class="w-full bg-gray-600 font-bold py-3 px-4 rounded transition-colors" id="mode-online-button">Create Online Game</button>
                    <button class="w-full bg-gray-600 font-bold py-3 px-4 rounded transition-colors" id="mode-hybrid-button">Create Hybrid Game</button>
                </div>
            </div>

            <!-- Join Game Flow -->
            <div id="join-game-flow">
                 <div class="text-center my-4">OR</div>
                <div class="mb-4">
                    <label class="block mb-2" for="join-game-id">Join Existing Game:</label>
                    <input class="w-full p-2 rounded bg-gray-700 text-white" id="join-game-id" placeholder="Enter Game ID" type="text"/>
                </div>
                <button class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded transition-colors" disabled id="join-game-button">Find Game</button>
            </div>

            <!-- MODIFIED: Host's Local Player Setup View -->
            <div id="local-player-setup-view" class="hidden">
                <p class="text-center text-gray-400 mb-4">You (the host) are Player 1. Add other local players below.</p>
                <div class="mb-4">
                    <label class="block mb-2" for="local-player-name">Add Local Player:</label>
                    <div class="flex gap-2">
                        <input class="w-full p-2 rounded bg-gray-700 text-white" id="local-player-name-input" placeholder="Enter local player's name" type="text"/>
                        <button class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded transition-colors" id="add-local-player-button">Add</button>
                    </div>
                </div>
                <div id="local-player-list" class="space-y-2 mb-6"></div>
                <button class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-4 rounded transition-colors" disabled id="create-hybrid-game-button">Create Hybrid Game</button>
                 <div class="text-center my-4"></div>
                 <button class="w-full bg-gray-500 hover:bg-gray-600 font-bold py-3 px-4 rounded transition-colors" id="back-to-mode-selection-button">Back</button>
            </div>

            <!-- NEW: Joiner's Group Setup View -->
            <div id="join-group-setup-view" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4">Joining Game: <span id="joining-game-id-display"></span></h2>
                <p class="text-center text-gray-400 mb-4">You are Player 1 for your group. Add other local players from your device below.</p>
                 <div class="mb-4">
                    <label class="block mb-2" for="joiner-local-player-name-input">Add Local Player:</label>
                    <div class="flex gap-2">
                        <input class="w-full p-2 rounded bg-gray-700 text-white" id="joiner-local-player-name-input" placeholder="Enter local player's name" type="text"/>
                        <button class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded transition-colors" id="add-joiner-local-player-button">Add</button>
                    </div>
                </div>
                <div id="joiner-local-player-list" class="space-y-2 mb-6"></div>
                <button class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-4 rounded transition-colors" id="confirm-join-group-button">Join Game with Group</button>
            </div>

        </div>

        <div class="hidden text-center" id="waiting-room-view">
            <h2 class="text-2xl font-bold mb-4">Waiting Room</h2>
            <p class="mb-2">Share this Game ID with others:</p>
            <div class="bg-gray-900 p-3 rounded-lg mb-4 flex items-center justify-center">
                <span class="text-2xl font-mono text-yellow-300" id="game-id-display"></span>
                <button class="ml-4 bg-gray-600 hover:bg-gray-500 text-sm py-1 px-2 rounded" id="copy-game-id">Copy</button>
            </div>
            <p class="mb-2 font-bold">Players Joined:</p>
            <div class="space-y-2 mb-6" id="player-list"></div>
            <p class="mb-4 text-gray-400" id="waiting-message">Waiting for more players...</p>
            <button class="w-full bg-green-600 hover:bg-green-700 font-bold py-3 px-4 rounded transition-colors" disabled id="start-game-button">Start Game</button>
        </div>
    </div>
</div>

<!-- Round End Screen -->
<div class="hidden" id="round-end-screen">
    <div class="w-full max-w-md" id="round-end-content">
        <h2 class="text-3xl font-bold text-center mb-4" id="round-end-title">Round Over!</h2>
        <p class="text-xl text-yellow-300 mb-4" id="round-winner-message"></p>
        <div class="mb-6" id="round-results-list"></div>
        <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded transition-colors" id="continue-round-button">Continue</button>
    </div>
</div>

<!-- Game Over Screen -->
<div class="hidden" id="game-over-screen">
    <div class="w-full max-w-md" id="final-score-display">
        <h2 class="text-4xl font-bold text-center mb-4 text-yellow-300">Game Over!</h2>
        <p class="text-xl mb-6" id="final-winner-message"></p>
        <div class="space-y-2 text-lg mb-8" id="final-score-list"></div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition-colors" id="main-menu-button-final">Main Menu</button>
    </div>
</div>

<!-- Main Game Container -->
<div class="hidden" id="game-container">
    <div id="game-layout">
        <div class="bg-gray-900 bg-opacity-70 p-2 rounded-lg shadow-lg flex justify-between items-center flex-wrap gap-4" id="game-info">
            <!-- Group 1: Left Controls -->
            <div class="flex items-center gap-4">
                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors" id="main-menu-button">New Game / Exit</button>
                <div>
                    <h2 class="font-bold text-lg">Current Turn: <span id="current-player"></span></h2>
                    <p class="text-sm text-yellow-300" id="game-status">Loading...</p>
                </div>
            </div>
            
            <!-- Group 2: Game Log & Pip Tally -->
            <div class="flex items-center gap-4 flex-grow justify-center">
                 <div id="game-log" class="flex-grow"></div>
                <div class="text-center px-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Your Hand Pips</h3>
                    <p id="hand-value-display" class="text-2xl font-bold text-yellow-300">0</p>
                </div>
            </div>

            <!-- Group 3: Right Controls -->
            <div class="flex items-center gap-4">
                <button class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded transition-colors" id="re-deal-button">Next Round</button>
                <select class="bg-gray-700 text-white rounded p-2" id="theme-switcher">
                    <option value="classic">Classic</option>
                    <option value="dr_edell">Dr. Edell</option>
                    <option value="austin">Austin</option>
                    <option value="rose">Rose</option>
                    <option value="anna">Anna</option>
                    <option value="kate">Kate</option>
                </select>
                <div class="text-right flex gap-4" id="scoreboard"></div>
            </div>
        </div>
        
        <div id="left-panel">
            <div id="player-hands-container">
                <!-- Player hands will be rendered here by JS -->
            </div>
            <div id="boneyard-container">
                <h2 class="text-xl font-semibold mb-3 text-center">Boneyard</h2>
                <div id="boneyard-pile" title="Click to draw a domino">
                    <div id="boneyard-stack"></div>
                    <span id="boneyard-count">0</span>
                </div>
                <div class="mt-2 flex items-center justify-center gap-2" id="boneyard-buttons">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors" id="undo-button">Undo</button>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors" id="end-turn-button">End Turn</button>
                    <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded transition-colors hidden" id="rotate-last-tile-button">Rotate Tile</button>
                    <!-- NEW: Validation Buttons -->
                    <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded transition-colors hidden" id="validate-move-button">Validate Move</button>
                    <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded transition-colors hidden" id="challenge-move-button">Challenge</button>
                </div>
            </div>
            <!-- NEW: Detailed Scoreboard Container -->
            <div id="detailed-scoreboard-container">
                <h3 class="text-lg font-semibold text-center mb-2">Score History</h3>
                <div id="detailed-scoreboard-content"></div>
            </div>
        </div>
        
        <div id="main-game-area">
            <div id="world-wrapper">
                <div id="world">
                    <div id="game-board">
                        <div id="starting-area"></div>
                    </div>
                    <div id="minimap-container">
                        <div id="minimap-viewport"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Firebase SDK -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

    // --- DOM Elements ---
    const dom = {
        loadingScreen: document.getElementById('loading-screen'),
        authStatus: document.getElementById('auth-status'),
        setupScreen: document.getElementById('setup-screen'),
        gameContainer: document.getElementById('game-container'),
        lobbyView: document.getElementById('lobby-view'),
        waitingRoomView: document.getElementById('waiting-room-view'),
        createGameButton: document.getElementById('create-game-button'),
        joinGameButton: document.getElementById('join-game-button'),
        startGameButton: document.getElementById('start-game-button'),
        reDealButton: document.getElementById('re-deal-button'),
        playerNameInput: document.getElementById('player-name'),
        joinGameIdInput: document.getElementById('join-game-id'),
        gameIdDisplay: document.getElementById('game-id-display'),
        gameIdHeader: document.getElementById('game-id-header'),
        copyGameIdButton: document.getElementById('copy-game-id'),
        playerList: document.getElementById('player-list'),
        waitingMessage: document.getElementById('waiting-message'),
        worldElement: document.getElementById('world'),
        gameBoardElement: document.getElementById('game-board'),
        boneyardPileElement: document.getElementById('boneyard-pile'),
        boneyardStack: document.getElementById('boneyard-stack'),
        boneyardContainer: document.getElementById('boneyard-container'),
        boneyardCountElement: document.getElementById('boneyard-count'),
        currentPlayerElement: document.getElementById('current-player'),
        endTurnButton: document.getElementById('end-turn-button'),
        undoButton: document.getElementById('undo-button'),
        rotateLastTileButton: document.getElementById('rotate-last-tile-button'),
        gameStatusElement: document.getElementById('game-status'),
        playerHandsContainer: document.getElementById('player-hands-container'),
        scoreboard: document.getElementById('scoreboard'),
        themeSwitcher: document.getElementById('theme-switcher'),
        roundEndScreen: document.getElementById('round-end-screen'),
        roundEndTitle: document.getElementById('round-end-title'),
        roundWinnerMessage: document.getElementById('round-winner-message'),
        roundResultsList: document.getElementById('round-results-list'),
        continueRoundButton: document.getElementById('continue-round-button'),
        minimapContainer: document.getElementById('minimap-container'),
        minimapViewport: document.getElementById('minimap-viewport'),
        gameOverScreen: document.getElementById('game-over-screen'),
        finalWinnerMessage: document.getElementById('final-winner-message'),
        finalScoreList: document.getElementById('final-score-list'),
        mainMenuButton: document.getElementById('main-menu-button'),
        mainMenuButtonFinal: document.getElementById('main-menu-button-final'),
        messageModal: document.getElementById('message-modal'),
        messageText: document.getElementById('message-text'),
        messageOkButton: document.getElementById('message-ok-button'),
        gameLog: document.getElementById('game-log'),
        handValueDisplay: document.getElementById('hand-value-display'),
        validateMoveButton: document.getElementById('validate-move-button'),
        challengeMoveButton: document.getElementById('challenge-move-button'),
        detailedScoreboardContent: document.getElementById('detailed-scoreboard-content'),
        
        // MODIFIED: Lobby DOM Elements
        createGameFlow: document.getElementById('create-game-flow'),
        joinGameFlow: document.getElementById('join-game-flow'),
        modeOnlineButton: document.getElementById('mode-online-button'),
        modeHybridButton: document.getElementById('mode-hybrid-button'),
        localPlayerSetupView: document.getElementById('local-player-setup-view'),
        localPlayerNameInput: document.getElementById('local-player-name-input'),
        addLocalPlayerButton: document.getElementById('add-local-player-button'),
        localPlayerList: document.getElementById('local-player-list'),
        createHybridGameButton: document.getElementById('create-hybrid-game-button'),
        backToModeSelectionButton: document.getElementById('back-to-mode-selection-button'),

        // NEW: Joiner Group Setup DOM Elements
        joinGroupSetupView: document.getElementById('join-group-setup-view'),
        joiningGameIdDisplay: document.getElementById('joining-game-id-display'),
        joinerLocalPlayerNameInput: document.getElementById('joiner-local-player-name-input'),
        addJoinerLocalPlayerButton: document.getElementById('add-joiner-local-player-button'),
        joinerLocalPlayerList: document.getElementById('joiner-local-player-list'),
        confirmJoinGroupButton: document.getElementById('confirm-join-group-button'),

        // Pass Device Screen Elements
        passDeviceScreen: document.getElementById('pass-device-screen'),
        nextPlayerNamePass: document.getElementById('next-player-name-pass'),
        confirmTurnButton: document.getElementById('confirm-turn-button'),
    };
    
    // --- Firebase & Game State ---
    let db, auth, analytics;
    let currentGameId = null;
    let currentPlayerId = null;
    let localGameState = {};
    let unsubscribeGameListener = null;
    let localPlayers = []; // For host
    let joinerLocalPlayers = []; // NEW: For joiner

    const SPINNER_VALUE = -1;
    const BOARD_SIZE = 2500;
    const DOMINO_WIDTH = 80;
    const DOMINO_HEIGHT = 40;
    
    // --- Interaction State ---
    let isDraggingDomino = false;
    let wasDragged = false;
    let dragStartPos = { x: 0, y: 0 };
    let dragStartTime = 0;
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let boardPosition = { x: 0, y: 0 };
    let zoomLevel = 1.0;
    const MIN_ZOOM = 0.3;
    const MAX_ZOOM = 3.0;
    let initialPinchDistance = null;
    let activeDominoElement = null;
    let draggedDominoData = null;
    let originalDominoElement = null;

    // --- Firebase Initialization ---
    async function initializeFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyCTmUo5UpQW77xhOkI_3XELSISo6WHyqLs",
                authDomain: "spinner-live.firebaseapp.com",
                projectId: "spinner-live",
                storageBucket: "spinner-live.appspot.com",
                messagingSenderId: "878930500451",
                appId: "1:878930500451:web:e281c28d5c29218044d156",
                measurementId: "G-BPHD3B8WDT"
            };
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            analytics = getAnalytics(app);

            dom.authStatus.textContent = 'Authenticating...';
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentPlayerId = user.uid;
                    enableLobby();
                } else {
                    await signInAnonymously(auth);
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            dom.authStatus.textContent = "Error: Could not connect. Please refresh.";
            showMessage(`Firebase Error: ${error.message}`);
        }
    }
    
    function showMessage(message) {
        dom.messageText.textContent = message;
        dom.messageModal.classList.remove('hidden');
    }

    dom.messageOkButton.addEventListener('click', () => {
        dom.messageModal.classList.add('hidden');
    });
    
    function enableLobby() {
        dom.authStatus.textContent = 'Ready to Play!';
        dom.loadingScreen.classList.add('hidden');
        dom.setupScreen.classList.remove('hidden');
        dom.joinGameButton.disabled = false;
    }

    // --- Lobby and Game Setup ---

    function showMainLobbyView() {
        dom.createGameFlow.classList.remove('hidden');
        dom.joinGameFlow.classList.remove('hidden');
        dom.localPlayerSetupView.classList.add('hidden');
        dom.joinGroupSetupView.classList.add('hidden');
    }

    function showHostHybridSetup() {
        dom.createGameFlow.classList.add('hidden');
        dom.joinGameFlow.classList.add('hidden');
        dom.localPlayerSetupView.classList.remove('hidden');
        updateLocalPlayerList();
    }
    
    // MODIFIED: Functions to manage the HOST's local player list
    function addLocalPlayer() {
        const name = dom.localPlayerNameInput.value.trim();
        if (name && localPlayers.length < 7) {
            localPlayers.push({ name });
            dom.localPlayerNameInput.value = '';
            updateLocalPlayerList();
        } else if (localPlayers.length >= 7) {
             showMessage("You can have a maximum of 8 players total (including you).");
        }
    }

    function removeLocalPlayer(index) {
        localPlayers.splice(index, 1);
        updateLocalPlayerList();
    }

    function updateLocalPlayerList() {
        dom.localPlayerList.innerHTML = '';
        if (localPlayers.length > 0) {
            localPlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-gray-700 p-2 rounded";
                item.innerHTML = `<span>${player.name}</span><button data-index="${index}" class="bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold">&times;</button>`;
                item.querySelector('button').addEventListener('click', () => removeLocalPlayer(index));
                dom.localPlayerList.appendChild(item);
            });
        } else {
             dom.localPlayerList.innerHTML = '<p class="text-gray-500 text-center text-sm">No local players added yet.</p>';
        }
        dom.createHybridGameButton.disabled = localPlayers.length === 0;
    }

    // NEW: Functions to manage the JOINER's local player list
    function addJoinerLocalPlayer() {
        const name = dom.joinerLocalPlayerNameInput.value.trim();
        if (name && joinerLocalPlayers.length < 7) {
            joinerLocalPlayers.push({ name });
            dom.joinerLocalPlayerNameInput.value = '';
            updateJoinerLocalPlayerList();
        } else if (joinerLocalPlayers.length >= 7) {
             showMessage("You can have a maximum of 8 players total in your group (including you).");
        }
    }

    function removeJoinerLocalPlayer(index) {
        joinerLocalPlayers.splice(index, 1);
        updateJoinerLocalPlayerList();
    }

    function updateJoinerLocalPlayerList() {
        dom.joinerLocalPlayerList.innerHTML = '';
        if (joinerLocalPlayers.length > 0) {
            joinerLocalPlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-gray-700 p-2 rounded";
                item.innerHTML = `<span>${player.name}</span><button data-index="${index}" class="bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold">&times;</button>`;
                item.querySelector('button').addEventListener('click', () => removeJoinerLocalPlayer(index));
                dom.joinerLocalPlayerList.appendChild(item);
            });
        } else {
             dom.joinerLocalPlayerList.innerHTML = '<p class="text-gray-500 text-center text-sm">No other local players added yet.</p>';
        }
    }

    // MODIFIED: Create game is now simpler
    const handleCreateOnlineGame = async () => {
        if (!currentPlayerId) return;
        const playerName = dom.playerNameInput.value.trim() || `Player ${currentPlayerId.substring(0, 4)}`;
        
        const players = {
            [currentPlayerId]: { id: currentPlayerId, controller: currentPlayerId, name: playerName, score: 0, hand: [], isHost: true }
        };
        const playerOrder = [currentPlayerId];
        
        await createGameInFirestore(players, playerOrder);
    };
    
    const handleCreateHybridGame = async () => {
        if (!currentPlayerId) return;
        const hostName = dom.playerNameInput.value.trim() || `Player ${currentPlayerId.substring(0, 4)}`;

        const players = {
            [currentPlayerId]: { id: currentPlayerId, controller: currentPlayerId, name: hostName, score: 0, hand: [], isHost: true }
        };
        const playerOrder = [currentPlayerId];

        localPlayers.forEach((p, i) => {
            const localId = `local_${Date.now()}_${i}`;
            players[localId] = { id: localId, controller: currentPlayerId, name: p.name, score: 0, hand: [], isHost: false };
            playerOrder.push(localId);
        });

        await createGameInFirestore(players, playerOrder);
    };

    async function createGameInFirestore(players, playerOrder) {
        const tempGameRef = doc(collection(db, 'games'));
        const gameId = tempGameRef.id.substring(0, 6).toUpperCase();
        const gameRef = doc(db, "games", gameId);

        const initialGameState = {
            players, playerOrder, gameStatus: 'waiting', boardDominos: [], boneyard: [],
            currentPlayerIndex: 0, roundNumber: 0, currentStartingDouble: 9, turnState: 'WAITING',
            hasDrawn: false, scoreHistory: [], mustDrawToStart: false, lastPlayedDominoId: null,
            passCount: 0, moveHistory: [], log: [], currentTheme: 'classic',
            createdAt: serverTimestamp(), turnConfirmationPending: false,
        };

        await setDoc(gameRef, initialGameState);
        await joinGame(gameId);
    }

    // MODIFIED: `handleJoinGame` now triggers the group setup flow.
    const handleFindGame = async () => {
        const gameId = dom.joinGameIdInput.value.trim().toUpperCase();
        if (!gameId) {
            showMessage("Please enter a Game ID.");
            return;
        }

        const gameRef = doc(db, "games", gameId);
        const gameSnap = await getDoc(gameRef);

        if (!gameSnap.exists()) {
            showMessage("Game not found. Please check the ID.");
            return;
        }
        
        // Show the group setup view for the joiner
        dom.createGameFlow.classList.add('hidden');
        dom.joinGameFlow.classList.add('hidden');
        dom.joinGroupSetupView.classList.remove('hidden');
        dom.joiningGameIdDisplay.textContent = gameId;
        updateJoinerLocalPlayerList();
    };

    // NEW: Finalizes joining with a group.
    const handleConfirmJoinGroup = async () => {
        if (!currentPlayerId) return;
        const gameId = dom.joiningGameIdDisplay.textContent;
        const playerName = dom.playerNameInput.value.trim() || `Player ${currentPlayerId.substring(0, 4)}`;

        const gameRef = doc(db, "games", gameId);
        
        try {
            await runTransaction(db, async (transaction) => {
                const gameSnap = await transaction.get(gameRef);
                if (!gameSnap.exists()) throw new Error("Game not found.");
                
                const gameData = gameSnap.data();
                const newPlayers = {};
                const newPlayerOrder = [];

                // Add the main joining player
                newPlayers[`players.${currentPlayerId}`] = { id: currentPlayerId, controller: currentPlayerId, name: playerName, score: 0, hand: [], isHost: false };
                newPlayerOrder.push(currentPlayerId);

                // Add the local players for the joiner
                joinerLocalPlayers.forEach((p, i) => {
                    const localId = `local_${Date.now()}_${i}`;
                    newPlayers[`players.${localId}`] = { id: localId, controller: currentPlayerId, name: p.name, score: 0, hand: [], isHost: false };
                    newPlayerOrder.push(localId);
                });

                if (Object.keys(gameData.players).length + newPlayerOrder.length > 8) {
                    throw new Error("This would exceed the maximum of 8 players.");
                }

                transaction.update(gameRef, {
                    ...newPlayers,
                    playerOrder: [...gameData.playerOrder, ...newPlayerOrder]
                });
            });

            await joinGame(gameId);

        } catch (error) {
            console.error("Error joining game with group:", error);
            showMessage(error.message);
            showMainLobbyView(); // Go back to lobby on error
        }
    };


    dom.modeOnlineButton.addEventListener('click', handleCreateOnlineGame);
    dom.modeHybridButton.addEventListener('click', showHostHybridSetup);
    dom.backToModeSelectionButton.addEventListener('click', showMainLobbyView);
    dom.addLocalPlayerButton.addEventListener('click', addLocalPlayer);
    dom.localPlayerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addLocalPlayer(); });
    dom.createHybridGameButton.addEventListener('click', handleCreateHybridGame);
    
    dom.joinGameButton.addEventListener('click', handleFindGame);
    dom.addJoinerLocalPlayerButton.addEventListener('click', addJoinerLocalPlayer);
    dom.joinerLocalPlayerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addJoinerLocalPlayer(); });
    dom.confirmJoinGroupButton.addEventListener('click', handleConfirmJoinGroup);


    async function joinGame(gameId) {
        currentGameId = gameId;
        dom.lobbyView.classList.add('hidden');
        dom.waitingRoomView.classList.remove('hidden');
        dom.gameIdDisplay.textContent = gameId;
        
        if (unsubscribeGameListener) unsubscribeGameListener();
        unsubscribeGameListener = onSnapshot(doc(db, "games", currentGameId), (docSnap) => {
            if (docSnap.exists()) {
                handleGameStateUpdate(docSnap.data());
            } else {
                showMessage("The game has ended or was deleted.");
                leaveGame();
            }
        });
    }

    function leaveGame() {
        window.location.reload();
    }
    dom.mainMenuButton.addEventListener('click', leaveGame);
    dom.mainMenuButtonFinal.addEventListener('click', leaveGame);

    dom.copyGameIdButton.addEventListener('click', () => {
        navigator.clipboard.writeText(currentGameId).then(() => {
            dom.copyGameIdButton.textContent = 'Copied!';
            setTimeout(() => { dom.copyGameIdButton.textContent = 'Copy'; }, 2000);
        }).catch(err => {
            const textArea = document.createElement("textarea");
            textArea.value = currentGameId;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                dom.copyGameIdButton.textContent = 'Copied!';
            } catch (err) {
                dom.copyGameIdButton.textContent = 'Failed!';
            }
            document.body.removeChild(textArea);
            setTimeout(() => { dom.copyGameIdButton.textContent = 'Copy'; }, 2000);
        });
    });

    dom.startGameButton.addEventListener('click', () => {
        if (localGameState.players[currentPlayerId]?.isHost) {
            startRound();
        }
    });
    dom.reDealButton.addEventListener('click', () => {
        if (localGameState.players[currentPlayerId]?.isHost) {
            startRound();
        }
    });

    // --- Main Game State Handler ---
    function handleGameStateUpdate(gameState) {
        const oldTheme = localGameState.currentTheme;
        const wasWaiting = localGameState.gameStatus === 'waiting';

        localGameState = gameState;
        
        if (gameState.turnConfirmationPending) {
            const nextPlayer = gameState.players[gameState.playerOrder[gameState.currentPlayerIndex]];
            if (nextPlayer && nextPlayer.controller === currentPlayerId) {
                showPassDeviceScreen(nextPlayer.name);
                return;
            }
        }
        dom.passDeviceScreen.classList.add('hidden');

        if (!gameState.players || !gameState.playerOrder || gameState.playerOrder.length === 0) {
            return;
        }

        const playerIds = gameState.playerOrder;
        const playerCount = playerIds.length;
        const isHost = gameState.players[currentPlayerId]?.isHost;

        if (gameState.gameStatus === 'waiting') {
            dom.playerList.innerHTML = '';
            playerIds.forEach(pid => {
                const p = document.createElement('p');
                p.textContent = `${gameState.players[pid].name} ${gameState.players[pid].isHost ? '(Host)' : ''}`;
                dom.playerList.appendChild(p);
            });
            
            const canStart = isHost && playerCount >= 2 && playerCount <= 8;
            dom.startGameButton.disabled = !canStart;
            dom.reDealButton.classList.toggle('hidden', true);

            if (isHost) {
                if (playerCount < 2) dom.waitingMessage.textContent = "Need at least 2 players to start.";
                else if (playerCount > 8) dom.waitingMessage.textContent = "Cannot start with more than 8 players.";
                else dom.waitingMessage.textContent = "You're the host. Start the game when ready!";
            } else {
                dom.waitingMessage.textContent = "Waiting for the host to start the game...";
            }

            dom.waitingRoomView.classList.remove('hidden');
            dom.setupScreen.classList.remove('hidden');
            dom.gameContainer.classList.add('hidden');

        } else if (gameState.gameStatus === 'in-progress' || gameState.gameStatus === 'round-over' || gameState.gameStatus === 'finished') {
            dom.setupScreen.classList.add('hidden');
            dom.gameContainer.classList.remove('hidden');
            if (oldTheme !== gameState.currentTheme) {
                dom.themeSwitcher.value = gameState.currentTheme;
            }
            if (wasWaiting && gameState.gameStatus === 'in-progress') {
                centerBoardOnStart();
            }
            dom.reDealButton.classList.toggle('hidden', !isHost);
            renderGameUI(gameState);
        }
        
        if (gameState.gameStatus === 'round-over') {
            displayRoundEndScreen(gameState);
        } else {
            dom.roundEndScreen.classList.add('hidden');
        }

        if (gameState.gameStatus === 'finished') {
            showFinalScores(gameState);
        } else {
            dom.gameOverScreen.classList.add('hidden');
        }
    }
    
    function showPassDeviceScreen(nextPlayerName) {
        dom.gameContainer.classList.add('hidden');
        dom.nextPlayerNamePass.textContent = nextPlayerName;
        dom.passDeviceScreen.classList.remove('hidden');
    }

    dom.confirmTurnButton.addEventListener('click', async () => {
        const gameRef = doc(db, "games", currentGameId);
        await updateDoc(gameRef, { turnConfirmationPending: false });
    });
    
    // --- Core Game Logic ---
    // ... (generateDeck, shuffle, startRound, findRoundStarter, drawFromBoneyard, submitTurnForValidation, calculateHandValue, continueRoundButton are unchanged)
    
    // --- UI Rendering ---
    // ... (renderGameUI, updateStatusAndButtons, renderPlayerHands, and all other rendering functions are unchanged. They are already built to handle the controller logic correctly.)

    // --- The rest of the JS code is identical to the previous version ---
    // (It includes: all rendering functions, drag/drop logic, pan/zoom, undo, themes, validation, etc.)
    // No changes are needed in those functions because they rely on the `controller` property, which we are now setting correctly for all players.

    function generateDeck(){const e=[];for(let t=0;t<=9;t++)for(let o=t;o<=9;o++)e.push({top:t,bottom:o,id:`d-${t}-${o}`});for(let t=0;t<=9;t++)e.push({top:SPINNER_VALUE,bottom:t,id:`s-${t}`});return e.push({top:SPINNER_VALUE,bottom:SPINNER_VALUE,id:"d-s-s"}),e}function shuffle(e){for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}}async function startRound(){const e=doc(db,"games",currentGameId);await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())throw"Game does not exist!";const n=o.data(),r=n.playerOrder,a=r.length,d=generateDeck();shuffle(d);const i=a<=4?7:5,s={...n.players};r.forEach((e=>{s[e].hand=d.splice(0,i)}));const l=n.roundNumber+1,c=9-(l-1)%10;let m,p=!1;const u=findRoundStarter(s,r,c);if(-1!==u)m=u,p=!1;else{const e=n.roundEndInfo?.winnerId,o=r.indexOf(e);if(l>1&&e&&-1!==o)m=o,p=!0;else{let e=-1,o=-1;for(let t=0;t<r.length;t++){const n=r[t],a=calculateHandValue(s[n].hand);a>e&&(e=a,o=t)}m=o,p=!0}}t.update(e,{gameStatus:"in-progress",players:s,boneyard:d,boardDominos:[],roundNumber:l,currentStartingDouble:c,currentPlayerIndex:m,mustDrawToStart:p,turnState:"WAITING",hasDrawn:!1,lastPlayedDominoId:null,passCount:0,moveHistory:[],log:[`Round ${l} started. Waiting for ${s[r[m]].name}.`],roundEndInfo:null,turnConfirmationPending:!1})}))}function findRoundStarter(e,t,o){const n=(e,t)=>e.some((e=>e.top===t&&e.bottom===t)),r=e=>e.some((e=>e.top===SPINNER_VALUE&&e.bottom===SPINNER_VALUE));for(let a=0;a<t.length;a++){const r=t[a];if(n(e[r].hand,o))return a}for(let o=0;o<t.length;o++){const n=t[o];if(r(e[n].hand))return o}return-1}async function drawFromBoneyard(){const e=doc(db,"games",currentGameId);try{await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())throw"Game does not exist!";const n=o.data(),r=n.players[n.playerOrder[n.currentPlayerIndex]];if(r.controller!==currentPlayerId||n.hasDrawn||"WAITING"!==n.turnState||0===n.boneyard.length)return;const a=[...n.boneyard],d=a.pop(),i={...n.players};i[r.id].hand.push(d);const s=[...n.log||[]];s.push(`${r.name} drew from the boneyard.`),s.length>5&&s.shift(),t.update(e,{players:i,boneyard:a,hasDrawn:!0,log:s})}))}catch(e){console.error("Error drawing from boneyard:",e),showMessage("Could not draw a domino. Please try again.")}}dom.boneyardPileElement.addEventListener("click",drawFromBoneyard),dom.boneyardPileElement.addEventListener("touchstart",(e=>{e.preventDefault(),drawFromBoneyard()}));async function submitTurnForValidation(){const e=doc(db,"games",currentGameId);await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())throw"Game does not exist!";const n=o.data(),r=[...n.log||[]];n.hasDrawn&&"WAITING"===n.turnState?r.push(`${n.players[currentPlayerId].name} passed their turn.`):r.push(`${n.players[currentPlayerId].name} submitted their move for validation.`),r.length>5&&r.shift(),t.update(e,{turnState:"PENDING_VALIDATION",log:r})}))}dom.endTurnButton.addEventListener("click",submitTurnForValidation);function calculateHandValue(e){return e.reduce(((e,t)=>{const o=t.top===SPINNER_VALUE?10:t.top,n=t.bottom===SPINNER_VALUE?10:t.bottom;return e+o+n}),0)}dom.continueRoundButton.addEventListener("click",(()=>{localGameState.players[currentPlayerId]?.isHost&&startRound()}));function renderGameUI(e){const t=e.playerOrder[e.currentPlayerIndex],o=e.players[t],n=o?.controller===currentPlayerId;if(!isDraggingDomino){dom.gameBoardElement.querySelectorAll(".domino").forEach((e=>e.remove())),e.boardDominos.forEach((t=>{const o=createDomino(t.dominoData);o.style.position="absolute",o.style.left=`${t.x}px`,o.style.top=`${t.y}px`,o.style.transform=`rotate(${t.rotation}deg)`,o.dataset.rotation=t.rotation,o.dataset.id=t.dominoData.id,n&&(o.addEventListener("mousedown",(e=>startDominoDrag(e,t,"board"))),o.addEventListener("touchstart",(e=>startDominoDrag(e,t,"board")),{passive:!1})),"PENDING_VALIDATION"===e.turnState&&t.dominoData.id===e.lastPlayedDominoId&&o.classList.add("pending-validation-glow"),dom.gameBoardElement.appendChild(o)}))}updateMinimap(e.boardDominos),dom.playerHandsContainer.innerHTML="",dom.scoreboard.innerHTML="",renderPlayerHands(e),renderGameLog(e.log),renderDetailedScoreboard(e),e.playerOrder.forEach((t=>{renderScoreboardEntry(e.players[t],t)}));const r=e.players[currentPlayerId];r&&(dom.handValueDisplay.textContent=calculateHandValue(r.hand)),renderBoneyard(e,n),dom.currentPlayerElement.textContent=e.players[t].name,updateStatusAndButtons(e,n,t)}function updateStatusAndButtons(e,t,o){let n="";if(dom.endTurnButton.classList.add("hidden"),dom.validateMoveButton.classList.add("hidden"),dom.challengeMoveButton.classList.add("hidden"),t)switch(e.turnState){case"PENDING_VALIDATION":n="Waiting for other players to validate your move...";break;case"PLACED":n="You've played. You can adjust your tile or end your turn.",dom.endTurnButton.classList.remove("hidden"),dom.endTurnButton.disabled=!1;break;case"WAITING":default:e.hasDrawn?(n="You have drawn a tile. Play it or end your turn.",dom.endTurnButton.classList.remove("hidden"),dom.endTurnButton.disabled=!1):e.mustDrawToStart?n="You must draw to start the round.":0===e.boardDominos.length?n=`You must play the Double ${e.currentStartingDouble} or Double Spinner.`:n="Your turn. Play a domino or draw from the boneyard."}else n=`Waiting for ${e.players[o].name}...`,"PENDING_VALIDATION"===e.turnState&&(n=`Validate ${e.players[o].name}'s move.`,dom.validateMoveButton.classList.remove("hidden"),dom.challengeMoveButton.classList.remove("hidden"));isDraggingDomino||(dom.gameStatusElement.textContent=n),dom.undoButton.disabled=!(t&&(e.moveHistory||[]).length>0),dom.rotateLastTileButton.classList.toggle("hidden",!(t&&"PLACED"===e.turnState&&e.lastPlayedDominoId)),dom.boneyardPileElement.style.cursor=t&&"WAITING"===e.turnState&&!e.hasDrawn&&e.boneyard.length>0?"pointer":"not-allowed",dom.boneyardPileElement.classList.toggle("can-draw",t&&"WAITING"===e.turnState&&!e.hasDrawn&&e.boneyard.length>0)}function renderPlayerHands(e){const t=e.playerOrder,o=t[e.currentPlayerIndex],n=e.players[o],r=n?.controller===currentPlayerId,a=t.indexOf(currentPlayerId),d=-1!==a?[...t.slice(a),...t.slice(0,a)]:t;d.forEach((t=>{const a=e.players[t];if(!a)return;const d=t===o,i=t===currentPlayerId,s=document.createElement("div");s.className="player-hand-section",d&&s.classList.add("flashing-border");const l=document.createElement("h3");l.className="font-bold text-center mb-2 text-sm";let c="";i?c="(You)":a.controller===currentPlayerId?c="(Local)":a.isHost&&(c="(Host)"),l.textContent=`${a.name} ${c} (${a.hand.length})`;const m=document.createElement("div");m.className="player-hand-content";const p=i||d&&r;if(p)a.hand.forEach((e=>{const t=createDomino(e);t.dataset.id=e.id,d&&r&&"WAITING"===gameState.turnState?(t.addEventListener("mousedown",(o=>startDominoDrag(o,{dominoData:e},"hand"))),t.addEventListener("touchstart",(o=>startDominoDrag(o,{dominoData:e},"hand")),{passive:!1})):t.style.cursor="not-allowed",m.appendChild(t)}));else a.hand.forEach((()=>{const e=createDomino(null,!0,"mini");m.appendChild(e)}));s.appendChild(l),s.appendChild(m),dom.playerHandsContainer.appendChild(s)}))}function renderScoreboardEntry(e,t){if(!e)return;const o=document.createElement("p");o.textContent=`${e.name}: ${e.score}`,dom.scoreboard.appendChild(o)}function renderGameLog(e){if(!e)return;dom.gameLog.innerHTML="";e.forEach((e=>{const t=document.createElement("p");t.textContent=e,dom.gameLog.appendChild(t)})),dom.gameLog.scrollTop=dom.gameLog.scrollHeight}function renderBoneyard(e,t){dom.boneyardStack.innerHTML="";e.boneyard.length>0&&(()=>{const e=document.createElement("div");e.className="boneyard-domino-display",dom.boneyardStack.appendChild(e)})();const o=document.getElementById("boneyard-message");o&&o.remove(),t&&"WAITING"===e.turnState&&!e.hasDrawn&&e.boneyard.length>0&&(()=>{const e=document.createElement("div");e.id="boneyard-message",e.textContent="Click to Draw",dom.boneyardPileElement.appendChild(e)})(),dom.boneyardCountElement.textContent=e.boneyard.length}function displayRoundEndScreen(e){if(!e.roundEndInfo)return;if("finished"===e.gameStatus)return dom.gameOverScreen.classList.remove("hidden"),dom.gameContainer.classList.add("hidden"),void dom.roundEndScreen.classList.add("hidden");dom.gameContainer.classList.add("hidden"),dom.roundEndScreen.classList.remove("hidden");const{winnerId:t,points:o}=e.roundEndInfo;dom.roundEndTitle.textContent=`Round ${e.roundNumber} Over!`,dom.roundWinnerMessage.textContent=`${e.players[t].name} wins the round with 0 points!`,dom.roundResultsList.innerHTML="",e.playerOrder.forEach((n=>{const r=document.createElement("p"),a=e.players[n].score-(o[n]||0);r.textContent=`${e.players[n].name}: ${a} + ${o[n]||0} points = ${e.players[n].score} Total`,n===t&&r.classList.add("winner"),dom.roundResultsList.appendChild(r)}));const n=e.players[currentPlayerId]?.isHost;dom.continueRoundButton.disabled=!n,dom.continueRoundButton.textContent=n?"Start Next Round":"Waiting for Host..."}function showFinalScores(e){dom.gameContainer.classList.add("hidden"),dom.roundEndScreen.classList.add("hidden"),dom.gameOverScreen.classList.remove("hidden");const t=e.playerOrder.map((t=>({name:e.players[t].name,score:e.players[t].score}))).sort(((e,t)=>e.score-t.score)),o=t[0].score,n=t.filter((e=>e.score===o));n.length>1?dom.finalWinnerMessage.textContent=`It's a tie between ${n.map((e=>e.name)).join(" and ")}!`:dom.finalWinnerMessage.textContent=`${n[0].name} wins the game!`,dom.finalScoreList.innerHTML="",t.forEach((e=>{const t=document.createElement("p");t.textContent=`${e.name}: ${e.score} points`,e.score===o&&t.classList.add("winner"),dom.finalScoreList.appendChild(t)}))}function createDomino(e,t=!1,o="normal"){const n=document.createElement("div");if(n.className="domino","mini"===o&&n.classList.add("mini-domino"),t)return n.classList.add("domino-back"),n;return n.appendChild(createPipContainer(e.top,o)),n.appendChild(document.createElement("div")).className="divider",n.appendChild(createPipContainer(e.bottom,o)),n}function createPipContainer(e,t="normal"){const o=document.createElement("div");if(o.className="pip-container",e===SPINNER_VALUE){const e=document.createElement("div");e.className="spinner-icon";const t=localGameState.currentTheme||"classic";switch(t){case"classic":e.innerHTML='<svg viewBox="0 0 24 24" class="w-full h-full"><g stroke="#B91C1C" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M 12 12 L 12 4 L 6 4" /><path d="M 12 12 L 12 4 L 6 4" transform="rotate(60 12 12)" /><path d="M 12 12 L 12 4 L 6 4" transform="rotate(120 12 12)" /><path d="M 12 12 L 12 4 L 6 4" transform="rotate(180 12 12)" /><path d="M 12 12 L 12 4 L 6 4" transform="rotate(240 12 12)" /><path d="M 12 12 L 12 4 L 6 4" transform="rotate(300 12 12)" /></g></svg>';break;case"dr_edell":e.innerHTML="<div>🫁</div><div>🩺</div>";break;case"austin":e.innerHTML='<svg viewBox="0 0 24 24" class="w-full h-full"><path fill="#FFDE00" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z"/><path fill="#000000" d="M8.5,10.5c0.83,0,1.5-0.67,1.5-1.5S9.33,7.5,8.5,7.5S7,8.17,7,9S7.67,10.5,8.5,10.5z M15.5,10.5c0.83,0,1.5-0.67,1.5-1.5S16.33,7.5,15.5,7.5S14,8.17,14,9S14.67,10.5,15.5,10.5z"/><path fill="#D9534F" d="M18,14c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S19.1,14,18,14z M6,14c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S7.1,14,6,14z"/><path fill="#000000" d="M12,15c-1.66,0-3-1.34-3-3h1c0,1.1,0.9,2,2,2s2-0.9,2-2h1C15,13.66,13.66,15,12,15z"/></svg>';break;case"rose":e.innerHTML="<div>✍️</div><div>🧩</div>";break;case"anna":e.innerHTML='<svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="300pt" height="155pt" viewBox="0 0 300 155" preserveAspectRatio="xMidYMid meet"><g transform="translate(0,155) scale(0.1,-0.1)" fill="red" stroke="red"><path d="M599 1217 c-92 -35 -157 -104 -182 -194 -7 -29 -17 -43 -28 -43 -26 0 -69 -39 -69 -64 0 -28 33 -64 65 -72 19 -5 28 -19 45 -68 42 -126 159 -271 285 -351 28 -18 83 -49 122 -69 l73 -36 87 44 c206 103 340 248 402 433 12 34 21 82 21 107 l0 45 45 7 c25 3 61 3 80 0 34 -7 35 -8 35 -52 0 -24 9 -73 21 -107 62 -185 196 -330 402 -433 l87 -44 81 41 c204 102 350 256 404 426 13 39 23 53 41 57 32 8 64 45 64 72 0 25 -43 64 -71 64 -11 0 -19 7 -19 18 0 29 -49 124 -80 153 -16 15 -48 38 -72 51 -87 46 -253 24 -324 -43 l-22 -21 -43 31 c-73 54 -177 74 -259 51 -84 -23 -167 -101 -185 -173 -6 -23 -9 -24 -43 -15 -20 6 -64 7 -97 4 l-60 -6 -24 51 c-73 152 -283 195 -430 88 l-43 -31 -22 21 c-60 56 -211 86 -287 58z m205 -42 c18 -8 38 -21 45 -29 7 -9 17 -13 22 -10 5 3 9 1 9 -4 0 -21 40 -19 71 4 35 26 113 52 177 58 43 5 125 -19 158 -47 25 -20 49 -47 48 -55 0 -10 15 -28 58 -73 31 -32 35 -39 23 -49 -8 -7 -15 -19 -15 -26 0 -8 -3 -14 -7 -14 -5 0 -9 -23 -11 -51 -1 -28 -9 -64 -17 -80 -8 -15 -15 -34 -15 -42 0 -8 -7 -20 -15 -27 -8 -7 -15 -21 -15 -31 0 -11 -3 -19 -8 -19 -4 0 -16 -17 -27 -37 -23 -43 -122 -143 -180 -181 -22 -15 -74 -45 -116 -66 l-77 -39 -58 29 c-33 15 -62 27 -66 26 -5 -1 -8 2 -8 8 0 5 -6 10 -13 10 -8 0 -22 9 -32 20 -10 11 -23 20 -29 20 -7 0 -19 8 -27 18 -8 9 -38 38 -65 63 -43 40 -109 125 -107 139 0 3 -8 16 -18 29 -10 12 -21 38 -25 56 -3 18 -14 42 -25 54 -10 11 -19 25 -19 31 0 5 -6 10 -12 10 -7 0 -21 11 -31 25 -17 24 -17 24 21 54 25 21 42 45 51 75 16 55 75 121 135 150 38 18 59 22 117 18 39 -2 85 -10 103 -17z m1211 -19 c63 -38 95 -45 114 -22 16 19 100 58 111 51 5 -3 11 -2 14 3 5 8 104 8 136 0 44 -11 144 -93 134 -110 -3 -4 -1 -8 4 -8 5 0 15 -19 23 -42 7 -24 31 -60 51 -80 l38 -37 -31 -30 c-17 -17 -35 -31 -40 -31 -5 0 -12 -12 -15 -27 -12 -51 -54 -133 -96 -190 -58 -79 -71 -93 -85 -93 -7 0 -12 -5 -10 -10 1 -6 -11 -18 -27 -28 -16 -9 -40 -26 -53 -37 -50 -43 -162 -100 -193 -99 -18 1 -50 12 -70 25 -8 5 -26 14 -39 19 -99 43 -264 205 -312 308 -44 93 -46 98 -58 177 -7 46 -16 74 -28 83 -15 11 -16 14 -3 22 8 5 17 7 21 5 3 -3 12 7 19 20 7 14 17 25 22 25 4 0 8 6 8 14 0 13 41 60 88 100 26 22 81 32 162 29 44 -1 68 -9 115 -37z"/><path d="M631 1138 c-74 -21 -118 -73 -140 -165 -16 -67 -4 -127 47 -232 56 -114 164 -217 315 -300 l57 -32 48 27 c26 15 56 32 67 38 195 107 340 346 304 501 -16 69 -33 100 -71 128 -82 59 -192 55 -268 -11 -38 -32 -77 -99 -65 -111 3 -3 8 5 12 17 3 12 9 22 13 22 4 0 11 11 14 25 4 14 13 25 21 25 8 0 15 4 15 9 0 18 86 51 134 51 69 0 117 -27 148 -85 51 -95 48 -184 -9 -291 -20 -38 -41 -74 -47 -80 -6 -7 -33 -37 -61 -68 -27 -31 -55 -56 -62 -56 -7 0 -18 -9 -25 -20 -7 -11 -16 -20 -21 -20 -4 0 -31 -16 -61 -36 -50 -33 -92 -41 -112 -21 -4 4 -14 7 -21 7 -8 0 -34 14 -58 30 -24 17 -48 30 -54 30 -6 0 -18 11 -27 25 -9 14 -20 25 -25 25 -36 0 -190 225 -173 252 4 6 3 8 -3 5 -11 -7 -23 45 -23 104 0 70 50 150 116 185 25 13 132 13 154 0 50 -30 95 -75 110 -110 12 -27 19 -34 19 -21 2 51 -76 129 -151 152 -50 15 -70 15 -117 1z"/><path d="M1820 1141 c-89 -27 -126 -69 -150 -168 -34 -147 92 -363 285 -486 130 -82 125 -81 189 -47 154 81 259 180 320 305 64 127 65 234 5 321 -68 99 -214 106 -312 15 -31 -28 -57 -72 -57 -93 1 -7 8 1 17 17 23 44 101 115 126 116 12 0 41 2 63 5 112 15 208 -113 188 -247 -6 -40 -58 -167 -74 -179 -3 -3 -16 -21 -28 -40 -11 -19 -34 -47 -50 -62 -23 -21 -32 -24 -43 -15 -11 10 -11 9 -2 -3 10 -13 -3 -25 -70 -73 -45 -31 -90 -57 -99 -57 -9 0 -19 -4 -23 -9 -6 -10 -158 65 -163 80 -2 5 -8 7 -13 3 -5 -3 -12 2 -15 10 -3 9 -11 16 -18 16 -38 0 -206 231 -192 266 3 8 1 14 -5 14 -6 0 -9 7 -5 15 3 8 1 15 -4 15 -14 0 -12 83 3 132 6 22 30 61 52 85 38 43 43 45 106 50 49 4 73 1 97 -11 42 -22 86 -66 108 -107 9 -19 19 -29 21 -22 14 40 -72 125 -149 148 -56 16 -70 17 -108 6z"/></g></svg>';break;case"kate":e.innerHTML='<svg viewBox="0 0 100 100" class="w-full h-full"><rect x="10" y="25" width="80" height="50" rx="10" ry="10" fill="#F0C68C"/><path d="M 20 25 C 10 15, 10 5, 25 5 L 35 5 L 30 25 Z" fill="#6B4F4F"/><path d="M 80 25 C 90 15, 90 5, 75 5 L 65 5 L 70 25 Z" fill="#6B4F4F"/><circle cx="40" cy="45" r="5" fill="#2D2D2D"/><circle cx="60" cy="45" r="5" fill="#2D2D2D"/><path d="M 50 55 Q 45 60, 50 65 Q 55 60, 50 55 Z" fill="#2D2D2D"/><path d="M 35 70 C 40 65, 60 65, 65 70" stroke="#2D2D2D" stroke-width="3" fill="none"/><path d="M 30 35 Q 40 30, 50 35 Q 60 30, 70 35" stroke="#6B4F4F" stroke-width="2" fill="none"/></svg>';break;default:e.textContent="S"}return o.appendChild(e),o}const n={1:[5],2:[1,9],3:[1,5,9],4:[1,3,7,9],5:[1,3,5,7,9],6:[1,2,3,7,8,9],7:[1,2,3,5,7,8,9],8:[1,2,3,4,6,7,8,9],9:[1,2,3,4,5,6,7,8,9]};for(let e=1;e<=9;e++){const t=document.createElement("div");if(n[count]&&n[count].includes(e)){const e=document.createElement("div");e.className=`pip pip-color-${count}`,t.appendChild(e)}o.appendChild(t)}return o}function getEventCoords(e){return e.touches?.[0]||e.changedTouches?.[0]||e}function startDominoDrag(e,t,o){if(e.stopPropagation(),isDraggingDomino)return;const n=localGameState.players[localGameState.playerOrder[localGameState.currentPlayerIndex]];if(n.controller!==currentPlayerId)return;if("hand"===o&&"WAITING"!==localGameState.turnState)return void showMessage("You can only play a tile when it is your turn to play.");if("board"===o){if("PLACED"!==localGameState.turnState)return;if(!(localGameState.moveHistory||[]).some((e=>e.dominoId===t.dominoData.id)))return void showMessage("You can only reposition tiles played this turn.")}originalDominoElement=e.currentTarget,draggedDominoData=t,isDraggingDomino=!0,wasDragged=!1,dragStartTime=Date.now();const r=getEventCoords(e);dragStartPos={x:r.clientX,y:r.clientY},activeDominoElement=createDomino(draggedDominoData.dominoData),activeDominoElement.classList.add("dragging"),document.body.appendChild(activeDominoElement),originalDominoElement.style.opacity="0.3";const a=r.clientX-40,d=r.clientY-20,i=t.rotation||0;activeDominoElement.style.transform=`translate3d(${a}px, ${d}px, 0) rotate(${i}deg)`,dom.gameStatusElement.textContent="Moving a tile...";const s=e=>dragDomino(e),l=e=>endDominoDrag(e,o,s,l);document.addEventListener("mousemove",s),document.addEventListener("mouseup",l,{once:!0}),document.addEventListener("touchmove",s,{passive:!1}),document.addEventListener("touchend",l,{once:!0})}function dragDomino(e){if(!isDraggingDomino||!activeDominoElement)return;e.preventDefault();const t=getEventCoords(e);Math.abs(t.clientX-dragStartPos.x)>5||Math.abs(t.clientY-dragStartPos.y)>5&&(wasDragged=!0);const o=t.clientX-40,n=t.clientY-20,r=draggedDominoData.rotation||0;activeDominoElement.style.transform=`translate3d(${o}px, ${n}px, 0) rotate(${r}deg)`}async function endDominoDrag(e,t,o,n){if(document.removeEventListener("mousemove",o),document.removeEventListener("touchmove",o),!isDraggingDomino)return;const r=doc(db,"games",currentGameId),a=Date.now()-dragStartTime;if(!wasDragged&&a<200&&"board"===t){const e=parseInt(draggedDominoData.rotation||0),t=(e+45)%360;originalDominoElement&&(originalDominoElement.style.transform=`rotate(${t}deg)`,originalDominoElement.dataset.rotation=t),await runTransaction(db,(async e=>{const o=await e.get(r);if(!o.exists())throw"Game does not exist!";const n=o.data();let a=[...n.moveHistory||[]];const d=[...n.boardDominos],i=d.findIndex((e=>e.dominoData.id===draggedDominoData.dominoData.id));i>-1&&(a.push({type:"rotate",dominoId:draggedDominoData.dominoData.id,from:d[i].rotation}),d[i].rotation=t,e.update(r,{boardDominos:d,moveHistory:a}))}))}else if(wasDragged){const o=getEventCoords(e),n=dom.worldElement.getBoundingClientRect();if("hand"===t&&(o.clientX<n.left||o.clientX>n.right||o.clientY<n.top||o.clientY>n.bottom));else{const a=(o.clientX-n.left)/zoomLevel+boardPosition.x,d=(o.clientY-n.top)/zoomLevel+boardPosition.y,i=a-40,s=d-20;let l=i,c=s,m=parseInt(originalDominoElement.dataset.rotation||0);let p=!0;if(0===localGameState.boardDominos.length){const e=draggedDominoData.dominoData,t=localGameState.currentStartingDouble,o=e.top===t&&e.bottom===t,n=e.top===SPINNER_VALUE&&e.bottom===SPINNER_VALUE;o||n?(l=1210,c=1230,m=90):p=!1}if(p)try{await runTransaction(db,(async e=>{const o=await e.get(r);if(!o.exists())throw"Game does not exist!";const n=o.data();let a=[...n.boardDominos],d={...n.players},i=[...n.log||[]],s=[...n.moveHistory||[]];if("hand"===t){const t=d[currentPlayerId].hand,o=t.findIndex((e=>e.id===draggedDominoData.dominoData.id));if(o>-1){const n=t.splice(o,1)[0];a.push({dominoData:n,x:l,y:c,rotation:m}),i.push(`${d[currentPlayerId].name} played a tile.`),i.length>5&&i.shift(),s=[{type:"play",dominoId:n.id}],e.update(r,{boardDominos:a,players:d,turnState:"PLACED",moveHistory:s,lastPlayedDominoId:n.id,log:i})}}else{const t=a.findIndex((e=>e.dominoData.id===draggedDominoData.dominoData.id));t>-1&&(s.push({type:"reposition",dominoId:draggedDominoData.dominoData.id,from:{x:a[t].x,y:a[t].y}}),a[t].x=l,a[t].y=c,e.update(r,{boardDominos:a,moveHistory:s}))}}))}catch(e){console.error("Error during placement transaction:",e),showMessage("Error placing the domino. Please refresh.")}}}originalDominoElement&&(originalDominoElement.style.opacity="1"),activeDominoElement&&activeDominoElement.remove(),activeDominoElement=null,originalDominoElement=null,draggedDominoData=null,isDraggingDomino=!1}function centerBoardOnStart(){zoomLevel=1,boardPosition.x=1250-dom.worldElement.clientWidth/2,boardPosition.y=1250-dom.worldElement.clientHeight/2,updateBoardTransform()}function updateBoardTransform(){const e=dom.worldElement.clientWidth/zoomLevel,t=dom.worldElement.clientHeight/zoomLevel;boardPosition.x=Math.max(0,Math.min(boardPosition.x,2500-e)),boardPosition.y=Math.max(0,Math.min(boardPosition.y,2500-t)),dom.gameBoardElement.style.transform=`scale(${zoomLevel}) translate(${-boardPosition.x}px, ${-boardPosition.y}px)`,updateMinimap(localGameState.boardDominos||[])}function updateMinimap(e){if(!dom.minimapContainer)return;const t=dom.minimapContainer.clientWidth,o=t/2500,n=dom.worldElement.clientWidth/zoomLevel,r=dom.worldElement.clientHeight/zoomLevel;dom.minimapViewport.style.width=`${n*o}px`,dom.minimapViewport.style.height=`${r*o}px`,dom.minimapViewport.style.left=`${boardPosition.x*o}px`,dom.minimapViewport.style.top=`${boardPosition.y*o}px`,dom.minimapContainer.querySelectorAll(".minimap-dot").forEach((e=>e.remove())),e.forEach((e=>{const r=document.createElement("div");r.className="minimap-dot",r.style.left=`${(e.x+40)*o}px`,r.style.top=`${(e.y+20)*o}px`,r.style.transform=`translate(-50%, -50%) rotate(${e.rotation}deg)`,r.addEventListener("click",(t=>{t.stopPropagation(),boardPosition.x=e.x-n/2+40,boardPosition.y=e.y-r/2+20,updateBoardTransform()})),dom.minimapContainer.appendChild(r)}))}dom.worldElement.addEventListener("mousedown",(e=>{if(0!==e.button||isDraggingDomino||e.target!==dom.worldElement&&e.target!==dom.gameBoardElement&&"world-wrapper"!==e.target.id)return;isPanning=!0,dom.worldElement.classList.add("panning");const t=getEventCoords(e);panStart={x:t.clientX,y:t.clientY};const o=e=>pan(e),n=()=>endPan(o,n);document.addEventListener("mousemove",o),document.addEventListener("mouseup",n,{once:!0})}));function pan(e){if(!isPanning)return;const t=getEventCoords(e),o=t.clientX-panStart.x,n=t.clientY-panStart.y;boardPosition.x-=o/zoomLevel,boardPosition.y-=n/zoomLevel,panStart={x:t.clientX,y:t.clientY},updateBoardTransform()}function endPan(e,t){isPanning=!1,dom.worldElement.classList.remove("panning"),document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}dom.worldElement.addEventListener("wheel",(e=>{e.preventDefault(),handleZoom(-.01*e.deltaY,e.clientX,e.clientY)}),{passive:!1}),dom.worldElement.addEventListener("touchstart",(e=>{if(2===e.touches.length)e.preventDefault(),isPanning=!0,initialPinchDistance=getPinchDistance(e),panStart=getAverageTouch(e);else if(1===e.touches.length&&!isDraggingDomino){if(e.target!==dom.worldElement&&e.target!==dom.gameBoardElement&&"world-wrapper"!==e.target.id)return;isPanning=!0,dom.worldElement.classList.add("panning");const t=getEventCoords(e);panStart={x:t.clientX,y:t.clientY}}}),{passive:!1}),dom.worldElement.addEventListener("touchmove",(e=>{if(isPanning&&e.preventDefault(),2===e.touches.length&&isPanning){const t=getPinchDistance(e),o=t/initialPinchDistance;handleZoom(o-1,panStart.x,panStart.y),initialPinchDistance=t;const n=getAverageTouch(e),r=n.x-panStart.x,a=n.y-panStart.y;boardPosition.x-=r/zoomLevel,boardPosition.y-=a/zoomLevel,panStart=n,updateBoardTransform()}else 1===e.touches.length&&isPanning&&pan(e)}),{passive:!1}),dom.worldElement.addEventListener("touchend",(e=>{e.touches.length<2&&(isPanning=!1,initialPinchDistance=null,dom.worldElement.classList.remove("panning"))}));function getPinchDistance(e){const t=e.touches[0],o=e.touches[1];return Math.sqrt(Math.pow(t.clientX-o.clientX,2)+Math.pow(t.clientY-o.clientY,2))}function getAverageTouch(e){const t=e.touches[0],o=e.touches[1];return{x:(t.clientX+o.clientX)/2,y:(t.clientY+o.clientY)/2}}function handleZoom(e,t,o){const n=dom.worldElement.getBoundingClientRect(),r=t-n.left,a=o-n.top,d=r/zoomLevel+boardPosition.x,i=a/zoomLevel+boardPosition.y,s=Math.max(MIN_ZOOM,Math.min(MAX_ZOOM,zoomLevel*(1+e)));boardPosition.x=d-r/s,boardPosition.y=i-a/s,zoomLevel=s,updateBoardTransform()}dom.minimapContainer.addEventListener("click",(e=>{if(e.stopPropagation(),e.target.classList.contains("minimap-dot")||"minimap-viewport"===e.target.id)return;const t=dom.minimapContainer.clientWidth,o=t/2500,n=e.offsetX,r=e.offsetY,a=n/o,d=r/o,i=dom.worldElement.clientWidth/zoomLevel,s=dom.worldElement.clientHeight/zoomLevel;boardPosition.x=a-i/2,boardPosition.y=d-s/2,updateBoardTransform()})),dom.undoButton.addEventListener("click",(async()=>{const e=doc(db,"games",currentGameId);await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())return;const n=o.data();if(!n.moveHistory||0===n.moveHistory.length)return;const r=[...n.moveHistory],a=r.pop(),d=[...n.boardDominos],i=d.findIndex((e=>e.dominoData.id===a.dominoId));i>-1&&("reposition"===a.type?(d[i].x=a.from.x,d[i].y=a.from.y):"rotate"===a.type&&(d[i].rotation=a.from),t.update(e,{boardDominos:d,moveHistory:r}))}))})),dom.rotateLastTileButton.addEventListener("click",(async()=>{const e=doc(db,"games",currentGameId),t=localGameState.lastPlayedDominoId;if(!t)return;const o=dom.gameBoardElement.querySelector(`.domino[data-id="${t}"]`);o&&(()=>{const e=parseInt(o.dataset.rotation||0),t=(e+45)%360;o.style.transform=`rotate(${t}deg)`,o.dataset.rotation=t})(),await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())return;const n=o.data();if(!n.lastPlayedDominoId)return;const r=[...n.boardDominos],a=r.findIndex((e=>e.dominoData.id===n.lastPlayedDominoId));if(a>-1){const e=(r[a].rotation+45)%360;r[a].rotation=e,t.update(e,{boardDominos:r})}}))})),dom.themeSwitcher.addEventListener("change",(async e=>{if(currentGameId){const t=doc(db,"games",currentGameId);await updateDoc(t,{currentTheme:e.target.value})}})),dom.validateMoveButton.addEventListener("click",(async()=>{const e=doc(db,"games",currentGameId);await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())return;const n=o.data();if("PENDING_VALIDATION"!==n.turnState)return;const r=n.playerOrder[n.currentPlayerIndex],a=n.players[r].hand;if(0===a.length){let o={},a={round:n.roundNumber,scores:{}};const d={...n.players};Object.keys(d).forEach((e=>{const t=e===r?0:calculateHandValue(d[e].hand);d[e].score+=t,o[e]=t,a.scores[e]=t}));const i=[...n.scoreHistory||[],a],s=n.roundNumber>=10;t.update(e,{players:d,gameStatus:s?"finished":"round-over",roundEndInfo:{winnerId:r,points:o},turnState:"WAITING",hasDrawn:!1,scoreHistory:i})}else{const o=(n.currentPlayerIndex+1)%n.playerOrder.length,a=n.playerOrder[o],d=n.players[a].name,i=n.players[currentPlayerId].name,s=[...n.log||[],`${i} validated the move. It's now ${d}'s turn.`];s.length>5&&s.shift();const l=n.players[r].controller,c=n.players[a].controller,m=l===c;t.update(e,{currentPlayerIndex:o,turnState:"WAITING",hasDrawn:!1,moveHistory:[],lastPlayedDominoId:null,log:s,turnConfirmationPending:m})}}))})),dom.challengeMoveButton.addEventListener("click",(async()=>{const e=doc(db,"games",currentGameId);await runTransaction(db,(async t=>{const o=await t.get(e);if(!o.exists())return;const n=o.data();if("PENDING_VALIDATION"!==n.turnState)return;const r=n.players[currentPlayerId].name,a=n.playerOrder[n.currentPlayerIndex],d=n.players[a].name,i=[...n.boardDominos],s=i.findIndex((e=>e.dominoData.id===n.lastPlayedDominoId));if(s>-1){const e=i.splice(s,1)[0],o={...n.players};o[a].hand.push(e.dominoData);const l=[...n.log||[],`${r} challenged ${d}'s move! Tile returned.`];l.length>5&&l.shift(),t.update(e,{boardDominos:i,players:o,turnState:"WAITING",hasDrawn:!1,lastPlayedDominoId:null,moveHistory:[],log:l})}}))}));function renderDetailedScoreboard(e){const{scoreHistory:t,players:o,playerOrder:n}=e;if(!t||!dom.detailedScoreboardContent)return;dom.detailedScoreboardContent.innerHTML="";const r=document.createElement("table");r.id="detailed-scoreboard-table";const a=r.createTHead(),d=a.insertRow(),i=document.createElement("th");i.textContent="R",d.appendChild(i),n.forEach((e=>{const t=document.createElement("th");t.textContent=o[e].name.substring(0,3),d.appendChild(t)}));const s=r.createTBody();t.forEach((e=>{const t=s.insertRow();t.insertCell().textContent=e.round,n.forEach((o=>{t.insertCell().textContent=e.scores[o]??"0"}))}));const l=r.createTFoot(),c=l.insertRow();c.className="total-row";const m=c.insertCell();m.textContent="Total",n.forEach((e=>{const t=c.insertCell();t.textContent=o[e].score})),dom.detailedScoreboardContent.appendChild(r)}window.onload=initializeFirebase;

</script>
</body>
</html>
